<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GPS Tracking Dashboard</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f7fa;
            height: 100vh;
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .header h1 {
            font-size: 1.5em;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .status {
            display: flex;
            align-items: center;
            gap: 15px;
            font-size: 0.9em;
        }

        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #4ade80;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .container {
            display: flex;
            height: calc(100vh - 70px);
        }

        .sidebar {
            width: 350px;
            background: white;
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        .sidebar-header {
            padding: 20px;
            border-bottom: 1px solid #e5e7eb;
        }

        .sidebar-header h2 {
            color: #333;
            margin-bottom: 15px;
        }

        .add-vehicle-btn {
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .add-vehicle-btn:hover {
            transform: translateY(-2px);
        }

        .vehicle-list {
            flex: 1;
            overflow-y: auto;
        }

        .vehicle-item {
            padding: 15px 20px;
            border-bottom: 1px solid #e5e7eb;
            cursor: pointer;
            transition: background 0.2s;
            position: relative;
        }

        .vehicle-item:hover {
            background: #f9fafb;
        }

        .vehicle-item.active {
            background: #ede9fe;
            border-left: 4px solid #667eea;
        }

        .vehicle-name {
            font-weight: 600;
            color: #333;
            margin-bottom: 5px;
        }

        .vehicle-info {
            font-size: 0.85em;
            color: #666;
            display: flex;
            justify-content: space-between;
        }

        .vehicle-status {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.75em;
            font-weight: 600;
        }

        .status-online {
            background: #d1fae5;
            color: #065f46;
        }

        .status-offline {
            background: #fee2e2;
            color: #991b1b;
        }

        #map {
            flex: 1;
            height: 100%;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        .modal-content h2 {
            margin-bottom: 20px;
            color: #333;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #555;
            font-weight: 500;
        }

        .form-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.2s;
        }

        .form-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        .modal-buttons {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 25px;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-secondary {
            background: #e5e7eb;
            color: #333;
        }

        .btn:hover {
            transform: translateY(-2px);
        }

        .no-vehicles {
            text-align: center;
            padding: 40px 20px;
            color: #999;
        }

        .vehicle-details {
            position: absolute;
            bottom: 20px;
            right: 20px;
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            min-width: 300px;
            z-index: 1000;
            display: none;
        }

        .vehicle-details.active {
            display: block;
        }

        .vehicle-details h3 {
            color: #333;
            margin-bottom: 15px;
        }

        .detail-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #f0f0f0;
        }

        .detail-label {
            color: #666;
            font-weight: 500;
        }

        .detail-value {
            color: #333;
            font-weight: 600;
        }

        .delete-btn {
            width: 100%;
            margin-top: 15px;
            padding: 10px;
            background: #ef4444;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .delete-btn:hover {
            background: #dc2626;
        }

        /* Responsive Design */
        @media (max-width: 1024px) {
            .container {
                flex-direction: column;
            }

            .sidebar {
                width: 100%;
                max-height: 40vh;
            }

            .vehicle-details {
                bottom: 10px;
                right: 10px;
                left: 10px;
                min-width: auto;
            }
        }

        @media (max-width: 768px) {
            .header {
                padding: 12px 15px;
                flex-direction: column;
                gap: 10px;
            }

            .header h1 {
                font-size: 1.2em;
            }

            .status {
                font-size: 0.8em;
                gap: 10px;
            }

            .sidebar {
                max-height: 35vh;
            }

            .sidebar-header h2 {
                font-size: 1.1em;
            }

            .add-vehicle-btn {
                padding: 10px;
                font-size: 0.9em;
            }

            .vehicle-item {
                padding: 12px 15px;
            }

            .modal-content {
                padding: 20px;
                width: 95%;
            }

            .btn {
                padding: 10px 18px;
                font-size: 0.9em;
            }
        }

        @media (max-width: 480px) {
            .header h1 {
                font-size: 1em;
            }

            .status {
                font-size: 0.75em;
            }

            .sidebar {
                max-height: 30vh;
            }

            .vehicle-details {
                padding: 15px;
                font-size: 0.9em;
            }

            .detail-row {
                flex-direction: column;
                gap: 5px;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üó∫Ô∏è GPS Tracking Dashboard</h1>
        <div class="status">
            <div class="status-dot"></div>
            <span id="connection-status">Connected</span>
            <span id="vehicle-count">0 Vehicles</span>
        </div>
    </div>

    <div class="container">
        <div class="sidebar">
            <div class="sidebar-header">
                <h2>Vehicles</h2>
                <button class="add-vehicle-btn" onclick="openAddVehicleModal()">
                    + Add New Vehicle
                </button>
            </div>
            <div class="vehicle-list" id="vehicle-list">
                <div class="no-vehicles">
                    No vehicles registered yet.<br>
                    Click "Add New Vehicle" to get started.
                </div>
            </div>
        </div>

        <div id="map"></div>

        <div class="vehicle-details" id="vehicle-details">
            <h3 id="detail-name">Vehicle Name</h3>
            <div class="detail-row">
                <span class="detail-label">Speed:</span>
                <span class="detail-value" id="detail-speed">0 km/h</span>
            </div>
            <div class="detail-row">
                <span class="detail-label">Battery:</span>
                <span class="detail-value" id="detail-battery">100%</span>
            </div>
            <div class="detail-row">
                <span class="detail-label">Last Update:</span>
                <span class="detail-value" id="detail-time">-</span>
            </div>
            <div class="detail-row">
                <span class="detail-label">Coordinates:</span>
                <span class="detail-value" id="detail-coords">-</span>
            </div>
            <button class="delete-btn" onclick="deleteCurrentVehicle()">Delete Vehicle</button>
        </div>
    </div>

    <!-- Add Vehicle Modal -->
    <div class="modal" id="add-vehicle-modal">
        <div class="modal-content">
            <h2>Register New Vehicle</h2>
            <form id="add-vehicle-form">
                <div class="form-group">
                    <label for="device-id">Device ID *</label>
                    <input type="text" id="device-id" required placeholder="e.g., DEVICE001" />
                </div>
                <div class="form-group">
                    <label for="vehicle-name">Vehicle Name *</label>
                    <input type="text" id="vehicle-name" required placeholder="e.g., Company Van #1" />
                </div>
                <div class="form-group">
                    <label for="phone-number">Phone Number (optional)</label>
                    <input type="tel" id="phone-number" placeholder="e.g., +1234567890" />
                </div>
                <div class="modal-buttons">
                    <button type="button" class="btn btn-secondary" onclick="closeAddVehicleModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Register Vehicle</button>
                </div>
            </form>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.socket.io/4.6.1/socket.io.min.js"></script>
    <script>
        const API_URL = 'http://localhost:3000/api';
        let map, markers = {}, socket, currentVehicle = null;

        // Initialize map
        function initMap() {
            map = L.map('map').setView([0, 0], 2);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors'
            }).addTo(map);
        }

        // Connect to WebSocket
        function connectWebSocket() {
            socket = io('http://localhost:3000');
            
            socket.on('connect', () => {
                document.getElementById('connection-status').textContent = 'Connected';
                console.log('WebSocket connected');
            });

            socket.on('disconnect', () => {
                document.getElementById('connection-status').textContent = 'Disconnected';
                console.log('WebSocket disconnected');
            });

            socket.on('location_update', (data) => {
                console.log('Location update:', data);
                updateVehicleLocation(data);
            });
        }

        // Load all vehicles
        async function loadVehicles() {
            try {
                const response = await fetch(`${API_URL}/vehicles`);
                const vehicles = await response.json();
                
                document.getElementById('vehicle-count').textContent = `${vehicles.length} Vehicle${vehicles.length !== 1 ? 's' : ''}`;
                
                if (vehicles.length === 0) {
                    document.getElementById('vehicle-list').innerHTML = `
                        <div class="no-vehicles">
                            No vehicles registered yet.<br>
                            Click "Add New Vehicle" to get started.
                        </div>
                    `;
                    return;
                }

                // Load latest locations for all vehicles
                const locResponse = await fetch(`${API_URL}/locations/latest`);
                const locations = await locResponse.json();

                displayVehicles(vehicles, locations);
            } catch (error) {
                console.error('Error loading vehicles:', error);
            }
        }

        // Display vehicles in sidebar
        function displayVehicles(vehicles, locations) {
            const locMap = {};
            locations.forEach(loc => {
                locMap[loc.device_id] = loc;
            });

            const html = vehicles.map(vehicle => {
                const loc = locMap[vehicle.device_id];
                const isOnline = loc && (Date.now() - new Date(loc.timestamp).getTime() < 300000); // 5 minutes
                
                if (loc) {
                    updateMarker(vehicle, loc);
                }

                return `
                    <div class="vehicle-item" onclick="selectVehicle('${vehicle.device_id}')">
                        <div class="vehicle-name">${vehicle.name}</div>
                        <div class="vehicle-info">
                            <span>${vehicle.device_id}</span>
                            <span class="vehicle-status ${isOnline ? 'status-online' : 'status-offline'}">
                                ${isOnline ? 'Online' : 'Offline'}
                            </span>
                        </div>
                    </div>
                `;
            }).join('');

            document.getElementById('vehicle-list').innerHTML = html;
        }

        // Update or create marker
        function updateMarker(vehicle, location) {
            const { device_id } = vehicle;
            const { latitude, longitude, speed } = location;

            if (markers[device_id]) {
                markers[device_id].setLatLng([latitude, longitude]);
            } else {
                const marker = L.marker([latitude, longitude], {
                    title: vehicle.name || device_id
                }).addTo(map);

                marker.bindPopup(`
                    <strong>${vehicle.name || device_id}</strong><br>
                    Speed: ${speed ? speed.toFixed(1) : 0} km/h
                `);

                marker.on('click', () => selectVehicle(device_id));
                markers[device_id] = marker;
            }

            // Center map on first vehicle
            if (Object.keys(markers).length === 1) {
                map.setView([latitude, longitude], 13);
            }
        }

        // Update vehicle location in real-time
        function updateVehicleLocation(data) {
            const { device_id, latitude, longitude, speed } = data;
            
            // Update marker
            if (markers[device_id]) {
                markers[device_id].setLatLng([latitude, longitude]);
                markers[device_id].getPopup().setContent(`
                    <strong>${device_id}</strong><br>
                    Speed: ${speed ? speed.toFixed(1) : 0} km/h
                `);
            }

            // Update details panel if this vehicle is selected
            if (currentVehicle === device_id) {
                showVehicleDetails(data);
            }

            // Refresh vehicle list to update online status
            loadVehicles();
        }

        // Select a vehicle
        async function selectVehicle(device_id) {
            currentVehicle = device_id;

            // Update active state in list
            document.querySelectorAll('.vehicle-item').forEach(item => {
                item.classList.remove('active');
            });
            event.target.closest('.vehicle-item')?.classList.add('active');

            try {
                const response = await fetch(`${API_URL}/location/${device_id}/latest`);
                const data = await response.json();
                
                if (markers[device_id]) {
                    map.setView([data.latitude, data.longitude], 15);
                }

                showVehicleDetails(data);
            } catch (error) {
                console.error('Error loading vehicle details:', error);
            }
        }

        // Show vehicle details panel
        function showVehicleDetails(data) {
            document.getElementById('detail-name').textContent = data.vehicle_name || data.device_id;
            document.getElementById('detail-speed').textContent = `${data.speed ? data.speed.toFixed(1) : 0} km/h`;
            document.getElementById('detail-battery').textContent = data.battery_level ? `${data.battery_level}%` : 'N/A';
            document.getElementById('detail-time').textContent = new Date(data.timestamp).toLocaleString();
            document.getElementById('detail-coords').textContent = `${data.latitude.toFixed(6)}, ${data.longitude.toFixed(6)}`;
            document.getElementById('vehicle-details').classList.add('active');
        }

        // Delete current vehicle
        async function deleteCurrentVehicle() {
            if (!currentVehicle) return;
            
            if (!confirm('Are you sure you want to delete this vehicle and all its location history?')) {
                return;
            }

            try {
                const response = await fetch(`${API_URL}/vehicles/${currentVehicle}`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    if (markers[currentVehicle]) {
                        map.removeLayer(markers[currentVehicle]);
                        delete markers[currentVehicle];
                    }
                    
                    document.getElementById('vehicle-details').classList.remove('active');
                    currentVehicle = null;
                    loadVehicles();
                }
            } catch (error) {
                console.error('Error deleting vehicle:', error);
                alert('Failed to delete vehicle');
            }
        }

        // Modal functions
        function openAddVehicleModal() {
            document.getElementById('add-vehicle-modal').classList.add('active');
        }

        function closeAddVehicleModal() {
            document.getElementById('add-vehicle-modal').classList.remove('active');
            document.getElementById('add-vehicle-form').reset();
        }

        // Handle form submission
        document.getElementById('add-vehicle-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const deviceId = document.getElementById('device-id').value;
            const vehicleName = document.getElementById('vehicle-name').value;
            const phoneNumber = document.getElementById('phone-number').value;

            try {
                const response = await fetch(`${API_URL}/vehicles/register`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        device_id: deviceId,
                        name: vehicleName,
                        phone_number: phoneNumber
                    })
                });

                if (response.ok) {
                    closeAddVehicleModal();
                    loadVehicles();
                } else {
                    const error = await response.json();
                    alert(error.error || 'Failed to register vehicle');
                }
            } catch (error) {
                console.error('Error registering vehicle:', error);
                alert('Failed to register vehicle');
            }
        });

        // Initialize on page load
        initMap();
        connectWebSocket();
        loadVehicles();
    </script>
</body>
</html>
